---
title: CLI Audit Report
description: Audit of CLI commands against CLI design guidelines
---

# CLI Commands Audit Report

This report audits our CLI commands against the [CLI Guidelines](https://clig.dev/), focusing on critical and high-impact rules for AI agent integration and general usability.

## Executive Summary

| Command | `--json` | `--plan`/`--dry-run` | Exit Codes | TTY Check | Structured Errors | `--yes` Flag |
|---------|----------|---------------------|------------|-----------|-------------------|--------------|
| `orgs` | ✅ | N/A | ⚠️ | ✅ | ✅ | N/A |
| `projects` | ✅ | ❌ | ⚠️ | ✅ | ✅ | ❌ (unused) |
| `dev` | ✅ | ✅ | ✅ | ✅ | ✅ | N/A |
| `seed` | ✅ | ✅ | ✅ | ⚠️ | ✅ | N/A |
| `api-keys` | ✅ | N/A | ⚠️ | ⚠️ | ✅ | N/A |
| `profile` | ✅ | N/A | ⚠️ | ⚠️ | ✅ | N/A |
| `init` | ✅ | ❌ | ⚠️ | ✅ | ✅ | ❌ (unused) |
| `push` | ✅ | ✅ | ✅ | ⚠️ | ✅ | ✅ |
| `pull` | ✅ | ✅ | ✅ | ⚠️ | ✅ | ❌ |

**Legend:** ✅ Compliant | ⚠️ Partial | ❌ Missing | N/A Not Applicable

---

## Why This Matters

These guidelines ensure our CLI works well for:
- **AI agents** (like Claude Code, GitHub Copilot) that need structured output
- **CI/CD pipelines** that need reliable exit codes and non-interactive modes
- **Scripts** that pipe output between commands
- **Humans** who expect consistent, helpful behavior

---

## Detailed Findings

### 1. AI Agent Integration (CRITICAL)

#### `--json` Support ✅ ALL PASS
All commands support `--json` flag for machine-readable output. This is essential for AI agents and scripts that need to parse command output.

#### Structured Errors ✅ ALL PASS
All commands output structured JSON errors with `status: "error"` and `message` fields when `--json` is used.

#### Dry-Run Support ⚠️ PARTIAL

Commands that modify state should support `--dry-run` or `--plan` to preview changes without applying them.

| Command | Status | Notes |
|---------|--------|-------|
| `dev` | ✅ | Has `--dry-run` |
| `push` | ✅ | Has `--plan` |
| `pull` | ✅ | Has `--plan` |
| `seed` | ✅ | Has `--dry-run` |
| `init` | ❌ | Would be useful to preview file creation |
| `projects new` | ❌ | Would show project details before creation |

#### `--yes` Flag ⚠️ PARTIAL

Commands with confirmation prompts should support `--yes` to skip them in scripts.

| Command | Status | Notes |
|---------|--------|-------|
| `push` | ✅ | Has `--yes` and uses it |
| `pull` | ❌ | Has confirmation but no `--yes` flag |
| `projects` | ⚠️ | Has `--yes` in interface but doesn't use it |
| `init` | ⚠️ | Has `--yes` in interface but doesn't use it |

#### Progress to stderr ❌ NEEDS WORK

All commands use `p.spinner()` from `@clack/prompts` which writes to **stdout**. Progress indicators should go to **stderr** so stdout remains clean for machine parsing.

**Impact:** When piping output (e.g., `supa projects --json | jq`), progress text contaminates the data stream.

---

### 2. The Basics (CRITICAL)

#### Exit Codes ⚠️ PARTIAL

Programs should return `0` on success, non-zero on failure. Several commands use `return` instead of setting exit codes on errors:

| File | Issue |
|------|-------|
| `orgs.ts:27-28` | Uses `return` instead of `process.exit(1)` |
| `projects.ts:182-183` | Uses `return` instead of `process.exit(1)` |
| `api-keys.ts:77-78,89` | Uses `return` instead of `process.exit(1)` |

**Why it matters:** Scripts check exit codes to determine success/failure. A command that fails but returns `0` breaks error handling.

#### stdout vs stderr ⚠️ PARTIAL

- ✅ Errors correctly go to `stderr` via `console.error()`
- ❌ Progress/spinners incorrectly go to `stdout`
- ✅ Informational messages use `console.log()` (correct)

---

### 3. Interactivity (HIGH)

#### TTY Detection ⚠️ PARTIAL

Commands should check if they're running in a terminal before showing interactive prompts.

| Command | TTY Check | Location |
|---------|-----------|----------|
| `orgs` | ✅ | Line 52: `if (!process.stdin.isTTY)` |
| `projects` | ✅ | Line 208: `if (!options.json && !process.stdin.isTTY)` |
| `init` | ✅ | Line 178: `if (options.json \|\| !process.stdin.isTTY)` |
| `dev` | ✅ | Implicit via JSON mode |
| `push` | ⚠️ | No explicit check |
| `pull` | ⚠️ | No explicit check |
| `seed` | ⚠️ | No explicit check |
| `api-keys` | ⚠️ | No explicit check |
| `profile` | ⚠️ | No explicit check |

**Why it matters:** When running in CI or piped contexts, prompts hang forever waiting for input that will never come.

---

### 4. Signals & Control (HIGH)

#### Ctrl-C Handling ✅ PASS

- `dev.ts` has proper SIGINT/SIGTERM handlers (lines 1406-1421) for graceful shutdown
- Other commands are short-lived and don't need explicit handlers

---

### 5. Arguments & Flags (HIGH)

#### No Secrets in Flags ✅ PASS

All commands read secrets from environment variables, not flags:
- `SUPABASE_ACCESS_TOKEN` - Authentication
- `SUPABASE_DB_PASSWORD` - Database password

**Why it matters:** Flags appear in shell history, process listings, and logs. Environment variables are more secure.

#### Standard Flag Names ⚠️ PARTIAL

| Flag | Standard | Current | Status |
|------|----------|---------|--------|
| Dry-run | `--dry-run` / `-n` | `--plan` | ⚠️ Non-standard but documented |
| Verbose | `--verbose` / `-v` | `--verbose` | ✅ |
| Yes | `--yes` / `-y` | `--yes` | ✅ |
| JSON | `--json` | `--json` | ✅ |

---

## Priority Recommendations

### P0 - Critical (Block release)

1. **Progress to stderr**: Configure `@clack/prompts` spinner or use a stderr-based spinner for JSON mode compatibility

### P1 - High (Fix soon)

2. **Exit codes**: Change `return` to `process.exit(1)` or `process.exitCode = 1` for error paths in:
   - `orgs.ts`
   - `projects.ts`
   - `api-keys.ts`

3. **TTY checks**: Add explicit TTY checks to `push`, `pull`, `seed`, `api-keys`, `profile`

4. **`--yes` flag for pull**: Add `--yes` flag since `pull` has a confirmation prompt

### P2 - Medium (Backlog)

5. **`--dry-run` for init**: Would help agents preview file creation
6. **Unused `--yes` flags**: Either implement or remove from `projects`, `init`

---

## Code Examples for Fixes

### Fix: Exit codes with return

```typescript
// Before (orgs.ts:27)
return;

// After
process.exitCode = 1;
return;
```

### Fix: TTY check template

```typescript
// Add before interactive prompts
if (!options.json && !process.stdin.isTTY) {
  console.error("Error: Interactive mode requires a TTY.");
  console.error("Use --json for non-interactive output.");
  process.exit(1);
}
```

### Fix: Add --yes to pull

```typescript
// In pull options interface
interface PullOptions {
  // ... existing options
  yes?: boolean;
}

// Before confirmation
if (!options.yes) {
  const proceed = await p.confirm({ message: "Pull these changes?" });
  if (p.isCancel(proceed) || !proceed) {
    p.cancel("Cancelled");
    process.exit(0);
  }
}
```

---

## References

- [Command Line Interface Guidelines](https://clig.dev/)
- [12 Factor CLI Apps](https://medium.com/@jdxcode/12-factor-cli-apps-dd3c227a0e46)
- [POSIX Utility Conventions](https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap12.html)
